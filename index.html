<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pro Stone Optimizer v2.0</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #00e5ff; --text: #eceff1; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: var(--card); padding: 25px; border-radius: 12px; }
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .input-section { background: #252525; padding: 15px; border-radius: 8px; max-height: 80vh; overflow-y: auto; }
        .piece-card { background: #333; padding: 10px; margin-bottom: 15px; border-left: 4px solid var(--accent); border-radius: 4px; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; background: #121212; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        .canvas-area { background: #000; border-radius: 8px; position: sticky; top: 20px; height: fit-content; padding: 10px; text-align: center; }
        canvas { border: 1px solid #333; max-width: 100%; background-color: #1a1a1a; }
        .btn { cursor: pointer; border: none; padding: 10px; border-radius: 4px; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-add { background: #37474f; color: white; }
        .btn-calc { background: var(--accent); color: #000; font-size: 1.1em; }
        .coord-hint { font-size: 0.75em; color: #999; margin-bottom: 5px; }
        .stats { margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-item { background: #252525; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #333; }
        .val { display: block; font-size: 1.4em; color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-top:0; color:var(--accent)">Stone Layout Optimizer (Complex Geometry)</h2>
    
    <div class="grid">
        <div class="input-section">
            <label>Slab Dimensions (Inches)</label>
            <div style="display:flex; gap:10px">
                <input type="number" id="slabL" placeholder="Length" value="120">
                <input type="number" id="slabW" placeholder="Width" value="65">
            </div>

            <h4 style="margin-bottom:5px">Pieces & Templates</h4>
            <div id="pieceList">
                <div class="piece-card">
                    <input type="text" placeholder="Piece Name (e.g. L-Island)" class="p-name">
                    <p class="coord-hint">Coordinates (X,Y points separated by spaces):<br>Example L-Shape: 0,0 60,0 60,25 25,25 25,50 0,50</p>
                    <textarea class="p-coords" rows="3">0,0 80,0 80,25 25,25 25,60 0,60</textarea>
                </div>
            </div>
            
            <button class="btn btn-add" onclick="addPiece()">+ Add Complex Piece</button>
            <button class="btn btn-calc" onclick="runOptimization()">Optimize Layout</button>

            <div class="stats" id="statPanel" style="display:none">
                <div class="stat-item">Yield <span class="val" id="yieldVal">0%</span></div>
                <div class="stat-item">Waste <span class="val" id="wasteVal">0%</span></div>
            </div>
        </div>

        <div class="canvas-area">
            <canvas id="layoutCanvas"></canvas>
            <p style="font-size: 0.8em; color: #666;">Visual Representation (White = Slab, Blue = Cuts)</p>
        </div>
    </div>
</div>

<script>
    function addPiece() {
        const div = document.createElement('div');
        div.className = 'piece-card';
        div.innerHTML = `
            <input type="text" placeholder="Piece Name" class="p-name">
            <textarea class="p-coords" rows="3" placeholder="X,Y X,Y X,Y..."></textarea>
            <button class="btn" style="background:#5c1a1a; padding:4px; font-size:0.8em" onclick="this.parentElement.remove()">Remove</button>
        `;
        document.getElementById('pieceList').appendChild(div);
    }

    function parseCoords(coordStr) {
        return coordStr.trim().split(/\s+/).map(pair => {
            const [x, y] = pair.split(',').map(Number);
            return { x, y };
        });
    }

    function getBoundingBox(points) {
        const xs = points.map(p => p.x);
        const ys = points.map(p => p.y);
        return {
            w: Math.max(...xs) - Math.min(...xs),
            h: Math.max(...ys) - Math.min(...ys)
        };
    }

    function calculatePolygonArea(points) {
        let area = 0;
        for (let i = 0; i < points.length; i++) {
            let j = (i + 1) % points.length;
            area += points[i].x * points[j].y;
            area -= points[j].x * points[i].y;
        }
        return Math.abs(area / 2);
    }

    function runOptimization() {
        const slabL = parseFloat(document.getElementById('slabL').value);
        const slabW = parseFloat(document.getElementById('slabW').value);
        const canvas = document.getElementById('layoutCanvas');
        const ctx = canvas.getContext('2d');

        const scale = Math.min(600 / slabL, 400 / slabW);
        canvas.width = slabL * scale;
        canvas.height = slabW * scale;

        // Draw Slab
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        let totalCutArea = 0;
        const coordElements = document.querySelectorAll('.p-coords');
        
        let currentX = 2; // Margin
        let currentY = 2;
        let maxHeightInRow = 0;

        coordElements.forEach((el, index) => {
            const points = parseCoords(el.value);
            if (points.length < 3) return;

            const box = getBoundingBox(points);
            const area = calculatePolygonArea(points);
            totalCutArea += area;

            // Simple "Shelf" Packing Logic
            if (currentX + box.w > slabL) {
                currentX = 2;
                currentY += maxHeightInRow + 2;
                maxHeightInRow = 0;
            }

            // Draw Piece
            ctx.beginPath();
            ctx.moveTo((points[0].x + currentX) * scale, (points[0].y + currentY) * scale);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo((points[i].x + currentX) * scale, (points[i].y + currentY) * scale);
            }
            ctx.closePath();
            
            ctx.fillStyle = "rgba(0, 229, 255, 0.6)";
            ctx.fill();
            ctx.strokeStyle = "#004d40";
            ctx.lineWidth = 2;
            ctx.stroke();

            // Label
            ctx.fillStyle = "#000";
            ctx.font = "12px sans-serif";
            ctx.fillText(`#${index+1}`, (currentX + 2) * scale, (currentY + 15) * scale);

            currentX += box.w + 2;
            maxHeightInRow = Math.max(maxHeightInRow, box.h);
        });

        // Statistics
        const slabArea = slabL * slabW;
        const yieldPerc = ((totalCutArea / slabArea) * 100).toFixed(1);
        const wastePerc = (100 - yieldPerc).toFixed(1);

        document.getElementById('statPanel').style.display = 'grid';
        document.getElementById('yieldVal').innerText = yieldPerc + "%";
        document.getElementById('wasteVal').innerText = wastePerc + "%";
    }
</script>

</body>
</html>
